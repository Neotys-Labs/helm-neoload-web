suite: test deployment
templates:
  - deployment-back.yaml
tests:
  - it: should work with default values and required custom values
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nlweb-back
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-nlweb
      - equal:
          path: spec.template.spec.containers[0].name
          value: nlweb-backend
  - it: should generate correct environment variables for basic configuration
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
    asserts:
      # Verify the total count of environment variables
      - lengthEqual:
          path: spec.template.spec.containers[0].env
          count: 28
      # Verify fixed-value environment variables
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MEMORY_MAX
            value: 2000m
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_PORT
            value: "27017"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_MAX_POOLSIZE
            value: "50"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NEOLOAD_WEB_PUBLIC_URL
            value: "http://myapp.example.com"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NEOLOAD_WEB_URL_NEXT_GEN
            value: "http://myapp.example.com"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NEOLOAD_WEB_PUBLIC_URL_NEXT_GEN
            value: "http://myapp.example.com/public"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NEOLOAD_WEB_API_PUBLIC_URL
            value: "http://myapi.example.com"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FILE_STORAGE_ROUTER_BASE_URL
            value: "http://myfiles.example.com"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: INTERNAL_FILE_STORAGE_ROUTER_BASE_URL
            value: "http://RELEASE-NAME-nlweb-svc-files.default.svc.cluster.local"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FILE_PROJECT_MAX_SIZE_IN_BYTES
            value: "250000000"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MAX_FORM_ATTRIBUTE_SIZE
            value: "32768"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NLPROJECT_MAX_UPLOADED_FILES_PER_WEEK
            value: "250"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SEND_USAGE_STATISTICS
            value: "true"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DEPLOYMENT_TYPE
            value: "helm/kubernetes"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HA
            value: "true"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: START_MODE
            value: "CLUSTER_KUB"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUB_NAMESPACE
            value: "default"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUB_HZ_PORT
            value: "6701"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HAZELCAST_KUBERNETES_SERVICE_PORT
            value: "6701"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HAZELCAST_KUBERNETES_RESOLVE_NOT_READY_ADDRESSES
            value: "true"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUB_SERVICE_NAME
            value: "RELEASE-NAME-nlweb-svc-hazelcast-api"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CORS_ALLOWED_ORIGIN_PATTERN
            value: "http://.*.example.com"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: COOKIE_DOMAIN
            value: ".example.com"
          any: true
      # Verify secret-based environment variables
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_HOST
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: host
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_LOGIN
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: username
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NLWEB_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-key-secret
                key: nlwSecretKey
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: INTERNAL_TOKEN_SECRET
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-key-secret
                key: internalTokenSecret
          any: true
      

